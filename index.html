<!DOCTYPE html>
<meta charset="utf-8">
<style>

svg {
	border: solid 1px #000;
}

circle {
	r: 25;
	stroke: #000;
}

</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js" charset="utf-8"></script>
<script src="actions.js" charset="utf-8"></script>
<script src="moves.js" charset="utf-8"></script>
<script src="dance_model.js" charset="utf-8"></script>

<body>
<script>
	var width = 1000,
		height = 500,
		tau = 2*Math.PI;

	var counts_per_second = 4,
		taus_per_count = 1/8;

	var svg = d3.select("body").append("svg")
		.attr("width", width)
		.attr("height", height);

	var count_display = d3.select("body").append("p")
		.text(0);

	var dance = new Dance(true);
	dance.addMove(new Allemande(4, 1, 75));
	dance.addMove(new Circle(6, 1, 75));
	dance.addMove(new Circle(10, -1, 75));

	var h4s = [];
	h4s.push(new Hands4([250,250], 75, dance));
	h4s.push(new Hands4([750,250], 75, dance));

	var dancers = [];
	for (var i = 0; i < h4s.length*4; i++) {
		dancers.push(
			{id: i,
			 pos: i % 4,
			 theta: 0});
		h4s[Math.floor(i/4)].dancers.push(dancers[i]);
		dancers[i].h4 = h4s[Math.floor(i/4)];
	}
	var dots = svg.selectAll("circle")
			.data(dancers)
			.enter().append("circle")
			.attr("fill", function(d) {
				switch(d.id % 4) {
					case 0:
						return "red";
					case 1:
						return "blue";
					case 2:
						return "green";
					case 3:
						return "yellow";
				}
			});


	var previousMove = dance.currentMove(0)[0];
	draw(0);
	d3.timer(animate);

	function draw(count) {
				dots.attr("cx", function(d) {
					return d.h4.getX(count, d.pos);
				})
				.attr("cy", function(d) {
					return d.h4.getY(count, d.pos);
				});
				count_display.text(Math.floor(count) % dance.duration);
	}

	function animate(elapsed) {
		var count = elapsed/1000 * counts_per_second;
		var currentMove = dance.currentMove(count)[0];

		if(previousMove !== currentMove) {
			dancers.forEach(function(dancer){
				dancer.pos = previousMove.posTransform(dancer.pos);
			});
			previousMove = currentMove;
		}
		draw(count);
	}

</script>
